import { useParams } from "react-router-dom";
import { useAuthStore } from "../src/stores/useAuthStore";
import { fakeEvents } from "../src/data/fakeEvents";
import { fakeTasks } from "../src/data/fakeTasks";
import VolunteerTaskLine from "../src/components/volunteer/VolunteerTaskLine";
import { fakeAddress } from "../src/data/fakeAddress";
import { fakeUser_task } from "../src/data/fakeUser_task";
import { ITasks } from "../src/interfaces/ITasks";
import { user_taskType } from "../src/interfaces/types";
import EventService from "../src/services/EventService";

const VolunteerTask = () => {
    // endpoints : 
    // endpoint côté gauche : GET /events/{event_id}
    // endpoint côté droit : GET /events/{event_id}/tasks

    // variables d'authentifications tirées du store
    const role = useAuthStore((state) => (state.user?.role));
    const token = useAuthStore((state) => (state.accessToken));

    const isVolunteer = role && role == "volunteer" ? true : false;

    // récupération des paramètres de l'URL :
    const { url_event_id } = useParams();
>

    // TODO: typage typescript
    // TODO: obtenir les infos à partir du Back après le SignIn (puis du user Store dans React) au lieu de passer par l'url ?

    // l'évènement correspond à l'event_id dans l'url - ex : http://localhost:5173/events/1/tasks
    //const event = fakeEvents.find((e) => (e.id === Number(url_event_id)))
    // son adresse peut être récupérée à partir de la clé address_id
    //const event_address = fakeAddress.find((a) => (a.id === event?.address_id));

    // récupérer liste des events associé au user connecté.

    // récupération Event + Adresse associée  pour CHAQUE EVENT CORRESPONDANT A LA LISTE PRECEDENTE
    const EventWithAddress = new EventService().getEventWithAddressById(1);

    // Dans la table des tasks, on récupère les tâches qui correspondent à l'event ID de la Route : 
    // <Route path='/events/:event_id/tasks' element={<VolunteerTask />} />
    const eventTasks = fakeTasks.filter((task) => (task.event_id === Number(url_event_id)));
    const uid = 89; // user_id en dur 
    // dans la table de jointure, on sélectionne toutes les tâches attribuées à l'utilisateur
    const userTasks = fakeUser_task.filter((item) => (item.user_id === uid));


    //fonction pour retourner un tableau des tâches correspondant à 1 event et 1 user (utilise les données de la table de jointure)
    function selectUserTasks(eventTaskArr: ITasks[], userTaskArr: user_taskType[]) {
        const tempArr = [];
        for (const taskObj of eventTaskArr) {
            if (Object.prototype.hasOwnProperty.call(taskObj, 'id')) {
                for (const line of userTaskArr) {
                    if (taskObj.id === line.task_id) {
                        tempArr.push(taskObj);
                    }
                }
            }
        }

        return tempArr;
    }


    // TODO: typer userTaskList

    const tasks = selectUserTasks(eventTasks, userTasks);

    // console.log
    console.log(`event_id : ${url_event_id}`);
    tasks.forEach((t, idx) => console.log(`TACHE ${idx} : ${t.name}`));

    function firstLetterUpper(str: string) {
        const first = str.charAt(0).toUpperCase();
        const rest = str.slice(1);
        return first + rest;
    }

    return (
        <>
            <div className={isVolunteer ? "" : "hidden"}>
                <div className="flex min-h-full flex-col justify-center px-6 py-12 lg:px-8 border-2 border-blue-400">
                    <div className="mt-10 sm:mx-auto sm:w-full sm:max-w-sm border-2 border-amber-100">
                        {/* <section id="sectionLeft" className="grid sm:grid-cols-[40%,60%] h-max bg-amber-400"> */}
                        {/* col-span-2 max-sm:-col-end-2  */}
                        <div className="bg-cyan-400/10 h-10 font-black">{EventWithAddress?. && firstLetterUpper(event.name)}</div>
                        <div className="grid grid-cols-5 gap-x-3 bg-neutral-50 h-96">
                            <div className="px-2 col-span-2 bg-red-0 text-sm">
                                <p className="font-semibold mt-2 mb-2">Adresse :</p>
                                <div className="border-2 border-stone-400 rounded-xl p-2">
                                    <ul>
                                        <li>
                                            {event_address?.street_number}, {event_address?.street_name}
                                        </li>
                                        <li>
                                            {event_address?.zip_code} {event_address?.city}
                                        </li>
                                    </ul>
                                </div>
                                <div className="mt-2 px-2">
                                    {event?.event_date ? `Prévu le : ${event?.event_date}` : ""}
                                </div>
                                <div className="mt-2 mb-2 px-2">
                                    Status : {event?.status}
                                </div>
                                <div className="border-2 border-stone-400 rounded-xl p-2">
                                    {event?.description}
                                </div>
                            </div>

                            <div className="px-2 col-span-3  bg-neutral-200">
                                <h2 className="leading-7">Tâches :</h2>
                                <hr /><br />
                                {
                                    tasks.length > 0 && tasks.map((t, index) => (
                                        <VolunteerTaskLine key={index} name={t.name} description={t.description} start_date={t.start_date} end_date={t.end_date} id={t.id} user_id={uid} />
                                    ))
                                }


                            </div>
                        </div>
                        <div className="bg-cyan-400/10 h-10">&nbsp;</div>
                        {/* </section> */}


                    </div>
                </div>

            </div>
            <span className={isVolunteer ? "" : "text-bold text-red-700 text-3xl"}>Vous devez être bénévole pour visualiser cet écran.</span>
        </>
    )

}

export default VolunteerTask;
